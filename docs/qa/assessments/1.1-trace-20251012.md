# Requirements Traceability Matrix

## Story: 1.1 - Platform Skeleton & Authentication

Date: 2025-10-12  
Analyst: Quinn (Test Architect)

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 2 (29%)
- Partially Covered: 3 (43%)
- Not Covered: 2 (29%)

### Requirement Mappings

#### AC1: Monorepo initialized with shared packages and CI pipeline

- Requirement 1.1 — Scaffolding, shared packages, and CI lint/test workflow stay in sync.  
  **Coverage: NONE**  
  - Tests: _No automated coverage implemented._  
  - Observation: CI workflow file exists but no pipeline simulation or contract test executes in the repo to prove the jobs run successfully.

#### AC2: Supabase authentication integrates email/password & OAuth with consent enforcement

- Requirement 2.1 — Backend session access denied until simulation consent acknowledged.  
  **Coverage: FULL (integration)**  
  - `apps/api/tests/test_auth.py::test_session_requires_consent`  
    - Given: Supabase service stub returns metadata without consent acknowledgement.  
    - When: `/api/v1/auth/session` is invoked with the stub token.  
    - Then: FastAPI responds with HTTP 403, confirming gating.  
  - Notes: Covers API-level enforcement for SEC-001.

- Requirement 2.2 — Persisting consent updates Supabase app metadata and unlocks session access.  
  **Coverage: FULL (integration)**  
  - `apps/api/tests/test_auth.py::test_consent_persist_updates_metadata`  
    - Given: Supabase stub tracking persist calls and acknowledging flag.  
    - When: Client posts to `/api/v1/auth/consent`, then fetches `/api/v1/auth/session`.  
    - Then: Consent request succeeds (204) and subsequent session returns acknowledged metadata.  
  - Notes: Validates metadata schema alignment with shared package.

- Requirement 2.3 — Email/password plus OAuth providers configured with hardened session refresh.  
  **Coverage: NONE**  
  - Tests: _No automated coverage implemented._  
  - Observation: Front-end toggles between sign-in/up, but there are no unit/integration/E2E tests ensuring provider enablement, refresh rotation, or redirect domain enforcement.

#### AC3: Post-login redirect provisions demo workspace with seeded guidance

- Requirement 3.1 — Backend bootstrap endpoints return seeded strategy and log creation once.  
  **Coverage: PARTIAL (integration)**  
  - `apps/api/tests/test_auth.py::test_workspace_provision_logs_once`  
    - Given: Workspace service with empty in-memory store and audit service stub.  
    - When: `/api/v1/strategies` and `/strategies/{strategyId}/versions` are invoked after consent.  
    - Then: Only one `WORKSPACE_CREATED` audit event recorded with demo strategy metadata.  
  - Gaps: Test asserts logging and single creation but does not assert block/callout payload content.

- Requirement 3.2 — Front-end store hydrates seeded workspace, preserves history, and supports guidance callouts.  
  **Coverage: PARTIAL (unit)**  
  - `apps/web/stores/workspace.test.ts::loads workspace seed and records history`  
    - Given: Zustand store reset and demo seed.  
    - When: `loadWorkspace` executes.  
    - Then: Seed cached and initial history entry recorded.  
  - `apps/web/stores/workspace.test.ts::trims history to the last 10 entries`  
    - Given: Multiple history pushes beyond capacity.  
    - When: `pushHistory` invoked twelve times.  
    - Then: History truncated to ten entries, maintaining recent changes.  
  - Gaps: No assertions for onboarding callouts or redirect behaviour after login.

#### AC4: Audit logging captures authentication events and workspace metadata

- Requirement 4.1 — Audit log stores workspace creation metadata for demo provisioning.  
  **Coverage: PARTIAL (integration)**  
  - `apps/api/tests/test_auth.py::test_workspace_provision_logs_once`  
    - Given: Audit service stub injected into FastAPI dependency graph.  
    - When: Demo workspace provisioning endpoints executed.  
    - Then: Audit history contains single `WORKSPACE_CREATED` event with strategy identifier metadata.  
  - Gaps: No coverage for auth success/failure logging, consent persistence audit, or error paths.

### Critical Gaps

1. CI/Turborepo workflow remains unverified in automation, leaving TECH-001 risk for regressions in pipeline orchestration.  
2. Authentication providers (email/password + OAuth) lack automated validation, exposing SEC-002 risk around session hardening and redirect safety.  
3. Audit trail only validated for workspace creation; auth success/failure and consent events remain untested, sustaining OPS-001 risk.

### Test Design Recommendations

1. Implement pipeline smoke test that executes `pnpm turbo run lint test` across workspaces locally or via workflow emulation to prove CI wiring (aligns with planned 1.1-INT-001/002).  
2. Add front-end integration/E2E tests (Playwright) covering consent gating, OAuth redirect domains, and session refresh to close SEC-001/002 gaps (planned 1.1-INT-004, 1.1-E2E-001/002).  
3. Extend FastAPI audit tests to assert auth event logging and consent persistence audit entries, mirroring scenarios in 1.1-INT-008/009.

### Risk Assessment

- **High Risk** — Requirements with no coverage (AC1 scaffolding, AC2 provider enablement) directly impact deployability and security posture.  
- **Medium Risk** — Partial coverage areas (workspace seeding fidelity, audit logging breadth) could hide regressions without integration/e2e tests.  
- **Low Risk** — Fully covered backend consent controls mitigate the most critical SEC-001 exposure.
