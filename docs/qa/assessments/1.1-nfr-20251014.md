# NFR Assessment – Story 1.1 (2025-10-14)

## Summary
- **Security — CONCERNS:** Auth flows enforce consent, but required rate limiting and audit streaming are still missing (`docs/architecture/security-and-performance.md:3`, `apps/api/blockbuilders_api/services/audit.py:12`).
- **Performance — CONCERNS:** No evidence of bundle monitoring or latency instrumentation to prove the <150 ms API target; onboarding chain issues multiple sequential calls without caching (`docs/architecture/security-and-performance.md:19`, `apps/web/lib/api/client.ts:7`).
- **Reliability — FAIL:** Audit logging and demo workspace state live only in memory, so restarts or multi-instance scaling lose required records (`apps/api/blockbuilders_api/services/audit.py:12`, `apps/api/blockbuilders_api/services/workspace.py:92`).
- **Maintainability — CONCERNS:** Backend tests exist but frontend coverage and CI config lag behind (still referencing the broken `uv install` path), creating drift with the agreed workflow (`apps/api/tests/test_auth.py:16`, `docs/architecture/deployment-architecture.md:25`).
- **Usability — PASS:** Login UX communicates consent requirements, exposes clear errors, and disables actions until policy acknowledgement (`apps/web/app/(auth)/login/page.tsx:24`).
- **Compatibility — PASS:** OAuth redirect handling respects environment configuration via `NEXT_PUBLIC_AUTH_REDIRECT_BASE_URL`, aligning with staged domain rollout (`apps/web/app/(auth)/login/page.tsx:67`).
- **Portability — CONCERNS:** Services hard-wire Supabase admin APIs with no local/offline fallback or retries, limiting deployment flexibility (`apps/api/blockbuilders_api/services/supabase.py:18`).
- **Functional Suitability — CONCERNS:** Major acceptance criteria are met, but the in-memory audit implementation undermines “trustworthy” logging called out in AC4 (`apps/api/blockbuilders_api/services/audit.py:12`).

**Quality Score:** 30 / 100  
**Gate Decision:** CONCERNS (blocked by reliability failure)

## Details

### Security — CONCERNS
- Architecture mandates Envoy + Redis throttling and audit event streaming, but the API ships without any rate limiting middleware or Datadog export (`docs/architecture/security-and-performance.md:9`, `apps/api/blockbuilders_api/routers/auth.py:12`).
- Recommendation: Introduce FastAPI-compatible rate limiting (e.g., SlowAPI with Redis) and publish auth/audit events to Datadog before release.

### Performance — CONCERNS
- No bundle or latency monitoring is wired despite the <150 ms P95 target; onboarding performs four sequential API calls with no batching (`docs/architecture/security-and-performance.md:19`, `apps/web/lib/auth/onboarding.ts:8`).
- Recommendation: Add Datadog traces around Supabase and workspace endpoints plus cache the post-login bootstrap chain where possible.

### Reliability — FAIL
- `AuditService` and `WorkspaceService` keep state in process memory, losing events and seeds on restart, violating the “trustworthy simulations” expectation (`apps/api/blockbuilders_api/services/audit.py:12`, `apps/api/blockbuilders_api/services/workspace.py:92`).
- Recommendation: Persist audit events to Postgres (or Supabase functions) and back demo seeding with deterministic database fixtures so all nodes share state.

### Maintainability — CONCERNS
- Backend tests only cover auth; frontend lacks matching Vitest suites, and CI docs still instruct the broken `uv install poetry` step the dev agent already corrected elsewhere (`apps/api/tests/test_auth.py:16`, `docs/architecture/deployment-architecture.md:25`).
- Recommendation: Update CI instructions to match working dependency installs and add smoke tests for the login/onboarding flow.

### Usability — PASS
- Consent checkbox is mandatory, copy references official policy, and error messages surface inline alerts (`apps/web/app/(auth)/login/page.tsx:32`).
- Recommendation: Add analytics events for consent acknowledgment to monitor onboarding friction.

### Compatibility — PASS
- OAuth redirect host derives from `NEXT_PUBLIC_AUTH_REDIRECT_BASE_URL`, allowing staging/production parity; client-only usage avoids Next.js SSR pitfalls (`apps/web/app/(auth)/login/page.tsx:67`).
- Recommendation: Document required Supabase redirect URLs alongside environment variables to prevent misconfiguration.

### Portability — CONCERNS
- Supabase admin calls lack retries/timeouts beyond defaults and require cloud connectivity; no local mock or feature flag for offline dev environments (`apps/api/blockbuilders_api/services/supabase.py:18`).
- Recommendation: Add retry/backoff, make base URL configurable for emulator usage, and document offline testing approach.

### Functional Suitability — CONCERNS
- Workspace seeding and consent flows satisfy primary acceptance criteria, yet audit persistence gaps undermine “trustworthy” onboarding promised in AC4 (`apps/api/blockbuilders_api/services/workspace.py:96`).
- Recommendation: Backfill durable audit storage and include regression tests that verify audit/event retention across restarts.
