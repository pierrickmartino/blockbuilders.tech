# Test Design: Story 1.1

Date: 2025-10-11  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 16
- Unit tests: 4 (25%)
- Integration tests: 9 (56%)
- E2E tests: 3 (19%)
- Priority distribution: P0: 10, P1: 6, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Monorepo initialized with shared packages and CI pipeline

| ID | Level | Priority | Test | Justification | Mitigates Risks |
| --- | --- | --- | --- | --- | --- |
| 1.1-UNIT-001 | unit | P0 | Validate shared schema package exports and version hashing stay in sync across TypeScript and Pydantic generators. | Prevents divergent contracts before integration points. | TECH-001 |
| 1.1-INT-001 | integration | P1 | `pnpm turbo run lint test --filter=...` executes successfully for `apps/web`, `apps/api`, and `packages/shared`. | Ensures monorepo pipeline coherence and CI parity. |  |
| 1.1-INT-002 | integration | P1 | CI workflow simulation verifies GitHub Actions fan out lint/test jobs and publishes artifacts. | Confirms pipeline wiring required by acceptance criteria. |  |

### AC2: Supabase authentication with consent enforcement

| ID | Level | Priority | Test | Justification | Mitigates Risks |
| --- | --- | --- | --- | --- | --- |
| 1.1-UNIT-002 | unit | P0 | `requireConsent` guard returns forbidden result until `simulationConsentAccepted` metadata true. | Fast feedback on critical consent logic. | SEC-001 |
| 1.1-UNIT-003 | unit | P0 | Session refresh handler enforces secure cookie attributes, rotation, and MFA requirements. | Validates security hardening without full stack. | SEC-002 |
| 1.1-INT-003 | integration | P0 | FastAPI `get_current_user` dependency denies requests lacking consent metadata and syncs Supabase profile on first login. | Verifies backend enforcement path. | SEC-001 |
| 1.1-INT-004 | integration | P0 | Next.js server-side middleware and route handlers block navigation/API access for users without consent. | Ensures frontend layer respects consent requirement. | SEC-001 |
| 1.1-E2E-001 | e2e | P0 | Playwright flow attempts to access authenticated dashboard before consenting and expects redirect with consent modal. | Validates full user journey defense. | SEC-001 |
| 1.1-E2E-002 | e2e | P1 | Playwright flow accepts consent then confirms seamless login, token refresh, and session persistence. | Ensures happy path stability post-guard. | SEC-002 |

### AC3: Demo workspace provisioning after authentication

| ID | Level | Priority | Test | Justification | Mitigates Risks |
| --- | --- | --- | --- | --- | --- |
| 1.1-UNIT-004 | unit | P1 | Demo workspace builder assembles canonical node/edge set and onboarding callout configuration. | Keeps seeded payload predictable and reviewable. | DATA-001 |
| 1.1-INT-005 | integration | P0 | FastAPI strategy seeding flow creates per-user strategy/version and scrubs PII; cross-tenant requests raise 403. | Validates tenant isolation requirements. | DATA-001 |
| 1.1-INT-006 | integration | P0 | PlanUsage quota service invoked during seeding; quota exhaustion returns surfaced error to frontend. | Protects compliance with plan guardrails. | DATA-001 |
| 1.1-INT-007 | integration | P1 | Performance probe measures login-to-dashboard redirect latency with seeding enabled and asserts < SLO budget. | Detects regressions tied to seeding overhead. | PERF-001 |
| 1.1-E2E-003 | e2e | P1 | Full login journey confirms seeded strategy visible, Zustand store populated, and onboarding callouts displayed. | Ensures user experience meets acceptance criteria. | DATA-001, PERF-001 |

### AC4: Audit logging for auth events and workspace creation

| ID | Level | Priority | Test | Justification | Mitigates Risks |
| --- | --- | --- | --- | --- | --- |
| 1.1-INT-008 | integration | P0 | Integration test asserts Supabase auth events and workspace creation metadata persist in compliance tables with correct schema. | Guarantees regulatory audit trail. | OPS-001 |
| 1.1-INT-009 | integration | P0 | Observability exporter test mocks Datadog intake, verifies retry queue on outage, and confirms alert emission. | Validates telemetry pipeline resilience. | OPS-001 |

## Risk Coverage

| Risk ID | Covered By |
| --- | --- |
| SEC-001 | 1.1-UNIT-002, 1.1-INT-003, 1.1-INT-004, 1.1-E2E-001 |
| SEC-002 | 1.1-UNIT-003, 1.1-E2E-002 |
| TECH-001 | 1.1-UNIT-001 |
| DATA-001 | 1.1-UNIT-004, 1.1-INT-005, 1.1-INT-006, 1.1-E2E-003 |
| OPS-001 | 1.1-INT-008, 1.1-INT-009 |
| PERF-001 | 1.1-INT-007, 1.1-E2E-003 |

## Recommended Execution Order

1. P0 unit tests (`1.1-UNIT-001` to `1.1-UNIT-003`) for rapid security and contract validation.  
2. P0 integration tests (`1.1-INT-003`, `1.1-INT-004`, `1.1-INT-005`, `1.1-INT-006`, `1.1-INT-008`, `1.1-INT-009`).  
3. P0 E2E test (`1.1-E2E-001`) to confirm end-to-end consent enforcement.  
4. Remaining P1 integrations (`1.1-INT-001`, `1.1-INT-002`, `1.1-INT-007`) and unit (`1.1-UNIT-004`).  
5. Conclude with P1 E2E journeys (`1.1-E2E-002`, `1.1-E2E-003`).

## Gate Summary Snippet

```yaml
test_design:
  scenarios_total: 16
  by_level:
    unit: 4
    integration: 9
    e2e: 3
  by_priority:
    p0: 10
    p1: 6
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace References

Test design matrix: `docs/qa/assessments/1.1-test-design-20251011.md`  
P0 tests identified: 10
