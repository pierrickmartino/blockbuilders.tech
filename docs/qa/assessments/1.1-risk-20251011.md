# Risk Profile: Story 1.1

Date: 2025-10-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 1
- High Risks: 4
- Risk Score: 35/100

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Consent Enforcement Bypass

**Score:** 9 (Critical)  
**Probability:** High — first-time integration of Supabase app metadata checks across Next.js and FastAPI increases the chance of missed guards.  
**Impact:** High — unauthenticated or non-consenting users could access simulation features, creating regulatory exposure.  
**Mitigation:**  
- Ensure both Next.js route handlers and FastAPI dependencies block access until `simulationConsentAccepted` metadata is true.  
- Add contract tests that seed users without consent and assert HTTP 403 responses across all protected endpoints.  
- Instrument audit trails for every consent mutation and denial to surface anomalies quickly.  
**Testing Focus:** Security regression tests and contract tests covering all authenticated routes; Playwright flows that attempt privileged access prior to consent.

## Risk Distribution

### By Category

- Security: 2 risks (1 critical)
- Technical: 1 risk (0 critical)
- Data: 1 risk (0 critical)
- Operational: 1 risk (0 critical)
- Performance: 1 risk (0 critical)

### By Component

- Frontend: 2 risks
- Backend: 2 risks
- Database: 1 risk
- Infrastructure: 1 risk

## Risk Matrix

| Risk ID | Description | Probability | Impact | Score | Priority |
| --- | --- | --- | --- | --- | --- |
| SEC-001 | Consent gating can be bypassed if FastAPI dependency or Next.js middleware misses Supabase metadata checks. | High (3) | High (3) | 9 | Critical |
| SEC-002 | Session hardening gaps during token refresh can expose auth tokens or allow stale sessions. | Medium (2) | High (3) | 6 | High |
| TECH-001 | Shared contract drift between `packages/shared`, Next.js clients, and FastAPI routers breaks parity and type safety. | Medium (2) | High (3) | 6 | High |
| DATA-001 | Demo workspace seeding may leak seeded data across tenants or persist PII beyond consent. | Medium (2) | High (3) | 6 | High |
| OPS-001 | Audit logging pipeline to Datadog may fail or omit required compliance events. | Medium (2) | High (3) | 6 | High |
| PERF-001 | Workspace seeding logic may slow sign-in redirect, causing noticeable latency. | Medium (2) | Medium (2) | 4 | Medium |

## Detailed Risk Register

| Risk ID | Category | Title | Primary Component | Probability | Impact | Score | Priority |
| --- | --- | --- | --- | --- | --- | --- | --- |
| SEC-001 | Security | Consent Enforcement Bypass | Backend | High (3) | High (3) | 9 | Critical |
| SEC-002 | Security | Session Hardening Gaps | Infrastructure | Medium (2) | High (3) | 6 | High |
| TECH-001 | Technical | Shared Contract Divergence | Frontend | Medium (2) | High (3) | 6 | High |
| DATA-001 | Data | Demo Workspace Data Leakage | Database | Medium (2) | High (3) | 6 | High |
| OPS-001 | Operational | Audit Logging Pipeline Gaps | Backend | Medium (2) | High (3) | 6 | High |
| PERF-001 | Performance | Slow Auth Redirect Due to Seeding | Frontend | Medium (2) | Medium (2) | 4 | Medium |

### Mitigation Plans

#### SEC-001 – Consent Enforcement Bypass
- **Strategy:** Preventive  
- **Actions:**  
  - Centralize consent verification in shared middleware/dependencies for both FastAPI and Next.js Route Handlers.  
  - Add integration tests that attempt access without consent for each protected API and page.  
  - Log and alert on rejected requests lacking consent metadata.  
- **Testing Requirements:** Contract tests hitting every protected endpoint; Playwright flows for pre-consent users.  
- **Residual Risk:** Low — once unified guards and automated tests are in place.  
- **Owner:** Backend team  
- **Timeline:** Before enabling production traffic.

#### SEC-002 – Session Hardening Gaps
- **Strategy:** Preventive + Detective  
- **Actions:**  
  - Enforce secure cookie attributes, rotating refresh tokens, and MFA enforcement per security standards.  
  - Validate Supabase configuration for refresh token revocation and session inactivity timeouts.  
  - Add monitoring for anomalous session reuse and failed refresh attempts.  
- **Testing Requirements:** Security tests covering token refresh, forced logout, and MFA flows; chaos scenarios rotating keys mid-session.  
- **Residual Risk:** Medium — relies on Supabase platform assurances.  
- **Owner:** Platform security  
- **Timeline:** Prior to beta launch.

#### TECH-001 – Shared Contract Divergence
- **Strategy:** Preventive  
- **Actions:**  
  - Generate TypeScript and Pydantic models from a single schema source.  
  - Add CI checks validating that generated clients and routers share the same version hash.  
  - Document change management workflow for shared contracts.  
- **Testing Requirements:** Unit tests for shared schema serialization; CI diff checks for schema drift.  
- **Residual Risk:** Medium — human error possible without automation.  
- **Owner:** Full stack team  
- **Timeline:** With initial scaffold PR.

#### DATA-001 – Demo Workspace Data Leakage
- **Strategy:** Preventive + Detective  
- **Actions:**  
  - Scope seeded records to per-user namespaces and scrub PII before persistence.  
  - Configure automated cleanup for demo data when users delete accounts.  
  - Add telemetry to detect cross-tenant reads/writes.  
- **Testing Requirements:** Integration tests verifying tenant isolation in database fixtures; data privacy checks in CI.  
- **Residual Risk:** Low — with isolation enforcement and telemetry.  
- **Owner:** Backend data team  
- **Timeline:** Before onboarding flows go live.

#### OPS-001 – Audit Logging Pipeline Gaps
- **Strategy:** Detective + Corrective  
- **Actions:**  
  - Implement end-to-end tests that mock Datadog intake and assert receipt of audit events.  
  - Add fail-open verifications that queue audit events if Datadog is unavailable.  
  - Configure dashboards/alerts for pipeline failures.  
- **Testing Requirements:** Integration tests for logging exporters; smoke tests in staging verifying Datadog ingestion.  
- **Residual Risk:** Medium — external service outages remain possible.  
- **Owner:** DevOps/Observability  
- **Timeline:** Prior to SOC2 readiness review.

#### PERF-001 – Slow Auth Redirect Due to Seeding
- **Strategy:** Preventive  
- **Actions:**  
  - Offload heavy seeding to background worker or cache seeded payloads.  
  - Measure auth redirect latency in staging with production-like data volumes.  
  - Add client-side loading skeletons and timeouts for long-running steps.  
- **Testing Requirements:** Performance benchmarks on the login-to-dashboard path; synthetic monitoring for TTFB and paint metrics.  
- **Residual Risk:** Low — if performance budgets and monitoring are enforced.  
- **Owner:** Frontend performance squad  
- **Timeline:** Before public beta performance sign-off.

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- Automated contract tests and Playwright E2E suites that enforce consent gating (SEC-001).  
- Security regression testing for unauthorized access attempts across API and UI surfaces.

### Priority 2: High Risk Tests
- Token lifecycle and MFA regression suites covering refresh, revocation, and hardening scenarios (SEC-002).  
- Schema parity checks and type generation validation in CI pipelines (TECH-001).  
- Tenant isolation integration tests and privacy compliance checks (DATA-001).  
- Observability pipeline smoke tests and failure injection exercises (OPS-001).

### Priority 3: Medium Risk Tests
- Login redirect latency measurements with seeded workspaces (PERF-001).  
- Synthetic monitoring to ensure performance stays within SLOs post-deployment.

## Risk Acceptance Criteria

- **Must Fix Before Production:** SEC-001 and any other risk scoring 9; all security/data risks scoring 6 require sign-off after mitigation validation.  
- **Can Deploy with Mitigation:** Medium risks with documented compensating controls and active monitoring.  
- **Accepted Risks:** None proposed; elevate to leadership if trade-offs emerge.

## Monitoring Requirements

- Security alerts for anomalous consent denial rates and token refresh failures.  
- Datadog dashboards tracking audit pipeline health and ingestion lag.  
- Performance monitors for login redirect timing and dashboard interactive readiness.  
- Data integrity checks ensuring seeded demo records remain tenant-scoped.

## Risk Review Triggers

- Significant architecture or schema changes impacting auth flows.  
- Addition of new identity providers or consent requirements.  
- Discovery of security vulnerabilities in Supabase/Auth stack.  
- Performance regressions reported in onboarding flows.  
- Regulatory updates affecting consent or audit logging obligations.
