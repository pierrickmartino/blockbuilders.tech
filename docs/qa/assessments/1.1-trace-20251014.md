# Requirements Traceability Matrix

## Story: 1.1 - Platform Skeleton & Authentication

Date: 2025-10-14  
Analyst: Quinn (Test Architect)

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 2 (29%)
- Partially Covered: 3 (43%)
- Not Covered: 2 (29%)

### Requirement Mappings

#### AC1: Monorepo initialized with shared packages and CI pipeline

- Requirement 1.1 — Turborepo scaffold, shared packages, and CI lint/test workflow remain aligned.  
  **Coverage: NONE**  
  - Tests: _No automated coverage implemented._  
  - Observation: `.github/workflows/monorepo-ci.yml` exists, but no automation validates the workflow steps or verifies each workspace build against the canonical source tree.

#### AC2: Supabase authentication integrates email/password & OAuth with consent enforcement

- Requirement 2.1 — Backend session access denied until simulation consent acknowledged.  
  **Coverage: FULL (integration)**  
  - `apps/api/tests/test_auth.py::test_session_requires_consent`  
    - Given: Supabase stub returns metadata with `simulationOnly.acknowledged = False`.  
    - When: `/api/v1/auth/session` executes with the stub token.  
    - Then: FastAPI responds `403`, proving the guard blocks users without consent.

- Requirement 2.2 — Persisting consent updates Supabase app metadata and unlocks a compliant session.  
  **Coverage: FULL (integration)**  
  - `apps/api/tests/test_auth.py::test_consent_persist_updates_metadata`  
    - Given: Stubbed Supabase service tracking persist calls.  
    - When: Client posts to `/api/v1/auth/consent` and subsequently requests `/api/v1/auth/session`.  
    - Then: Consent endpoint returns `204`, `persist_calls == 1`, and the session payload shows acknowledged metadata.

- Requirement 2.3 — Email/password plus OAuth providers configured with hardened session refresh.  
  **Coverage: NONE**  
  - Tests: _No automated coverage implemented._  
  - Observation: There is no unit, integration, or E2E coverage asserting provider enablement, redirect-domain enforcement, or refresh token hardening (SEC-002 exposure).

#### AC3: Post-login redirect provisions demo workspace with seeded guidance

- Requirement 3.1 — Backend bootstrap endpoints seed the strategy once and emit audit metadata.  
  **Coverage: PARTIAL (integration)**  
  - `apps/api/tests/test_auth.py::test_workspace_provision_logs_once`  
    - Given: Audit service stub and workspace service injected into FastAPI.  
    - When: `/api/v1/strategies` and `/strategies/{strategyId}/versions` run post-consent.  
    - Then: Exactly one `WORKSPACE_CREATED` audit event persists with demo strategy metadata.  
  - `apps/api/tests/test_auth.py::test_workspace_seed_matches_spec`  
    - Given: Workspace service invoked with demo user metadata acknowledging consent.  
    - When: `get_or_create_demo_workspace` executes.  
    - Then: Seed returns canonical block ordering and risk/execution configuration.  
  - Gaps: Neither test asserts onboarding callouts or validates the HTTP payload contract returned to the front end.

- Requirement 3.2 — Front-end workspace store hydrates seed and preserves undo history for guided experience.  
  **Coverage: PARTIAL (unit)**  
  - `apps/web/stores/workspace.test.ts::loads workspace seed and records history`  
    - Given: Zustand store reset and demo seed fixture.  
    - When: `loadWorkspace` executes.  
    - Then: Seed persisted and history initialized with one entry.  
  - `apps/web/stores/workspace.test.ts::trims history to the last 10 entries`  
    - Given: Twelve sequential history pushes.  
    - When: `pushHistory` invoked repeatedly.  
    - Then: History capped at ten entries, maintaining recent snapshots.  
  - Gaps: No automated coverage ensures dashboard redirect occurs after login, onboarding callouts render (`welcome-consent` → `run-first-backtest`), or quota checks gate CTA usage.

#### AC4: Audit logging captures authentication events and workspace metadata

- Requirement 4.1 — Audit log records workspace creation metadata and consent journey.  
  **Coverage: PARTIAL (integration)**  
  - `apps/api/tests/test_auth.py::test_workspace_provision_logs_once`  
    - Given: Audit service stub collects emitted events.  
    - When: Demo workspace provisioning endpoints execute.  
    - Then: Single `WORKSPACE_CREATED` event contains the expected `strategyId` prefix.  
  - Gaps: No assertions for login success/failure audit entries, consent persistence logging, or error-path telemetry, leaving OPS-001 unresolved.

### Critical Gaps

1. CI/Turborepo workflow lacks automated smoke validation, so regressions in workspace wiring or lint/test orchestration can ship unchecked (TECH-001).  
2. OAuth/email provider enablement and redirect safety have zero coverage, keeping high-security risk around token refresh and domain gating (SEC-002).  
3. Guided onboarding flow is untested—callout registry tasks remain unchecked and there is no Playwright journey validating consent → redirect → checklist experience.  
4. Audit trail only verifies workspace creation; authentication success/failure and consent persistence are not logged under test, limiting incident reconstruction (OPS-001).

### Test Design Recommendations

1. Integrate a pipeline contract test (local or CI dry run) that executes `pnpm turbo run lint test --filter ...` across web/api/workers to confirm workflow integrity (align with planned 1.1-INT-001/002).  
2. Implement Playwright scenarios for login + consent gating, OAuth callback domain enforcement, and onboarding callout visibility per story subtasks (1.1-E2E-001/002/003).  
3. Extend FastAPI integration tests to assert audit logging for consent persistence, login success/failure, and error handling (1.1-INT-008/009).  
4. Add front-end store/unit coverage around callout lists and quota gating to guarantee alignment with `docs/front-end-spec.md`.

### Risk Assessment

- **High Risk** — Requirements with no coverage (AC1 scaffold/CI validation, AC2 provider hardening) threaten deployability and security posture.  
- **Medium Risk** — Partial areas (workspace seeding fidelity, onboarding UX, audit completeness) could hide regressions without integration/E2E automation.  
- **Low Risk** — Backend consent enforcement enjoys solid integration coverage, reducing the primary SEC-001 exposure.
