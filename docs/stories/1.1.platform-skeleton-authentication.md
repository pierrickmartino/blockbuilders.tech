# Story 1.1: Platform Skeleton & Authentication

## Status
Draft

## Story
**As a** new user,  
**I want** to sign up, authenticate, and land in a pre-configured workspace,  
**so that** I can immediately begin exploring strategy building in a trustworthy environment.

## Acceptance Criteria
1. Monorepo initialized with Next.js frontend, FastAPI API gateway, shared schema package, and CI lint/test pipeline.
2. Supabase (or equivalent) authentication integrated with email/password and OAuth, enforcing simulation-only consent checkbox.
3. Post-login redirect initializes a demo strategy workspace populated with sample blocks and educational callouts.
4. Audit logging captures auth events and workspace creation metadata.

## Tasks / Subtasks
- [ ] Establish monorepo foundation and shared packages (AC: 1)  
  - [ ] Scaffold `apps/web`, `apps/api`, `apps/workers`, and `packages/shared` with Turborepo using Next.js 15, FastAPI, and shared schema stubs to match the canonical layout ([Source: architecture/unified-project-structure.md#unified-project-structure], [Source: architecture/tech-stack.md#tech-stack])  
  - [ ] Wire shared TypeScript/Pydantic contracts from `packages/shared` into the Next.js API client and FastAPI router skeletons to keep a single source of truth ([Source: architecture/coding-standards.md#critical-fullstack-rules])  
  - [ ] Configure GitHub Actions + Turborepo pipeline to lint and test web/api apps on every push ([Source: architecture/tech-stack.md#tech-stack], [Source: architecture/development-workflow.md#development-commands])  
  - [ ] Provide `.env` and `.env.local` templates with API, Supabase, Stripe, Redis, OTEL, and logging variables so developers can bootstrap locally ([Source: architecture/development-workflow.md#environment-configuration])
- [ ] Implement Supabase authentication and consent enforcement (AC: 2)  
  - [ ] Integrate Supabase Auth in Next.js via `createClientComponentClient`, login route group under `(auth)/login`, and service-layer token injection ([Source: architecture/frontend-architecture.md#frontend-services-layer], [Source: architecture/frontend-architecture.md#routing-architecture])  
  - [ ] Secure FastAPI routes with the `get_current_user` dependency, syncing Supabase user/app metadata on first login ([Source: architecture/backend-architecture.md#middlewareguards], [Source: architecture/backend-architecture.md#auth-flow])  
  - [ ] Persist simulation-only consent acknowledgement in Supabase app metadata and enforce API/route access until present ([Source: architecture/backend-architecture.md#auth-flow])  
  - [ ] Enable email/password and OAuth providers, ensuring token refresh and session hardening follow security guardrails ([Source: architecture/security-and-performance.md#security-requirements])
- [ ] Provision demo workspace after authentication (AC: 3)  
  - [ ] On successful auth, call FastAPI to create or fetch a seeded `Strategy` plus first `StrategyVersion` for the user using `/api/v1/strategies` and `/strategies/{strategyId}/versions` ([Source: architecture/api-specification.md#api-specification], [Source: architecture/data-models.md#strategy])  
  - [ ] Populate the Zustand canvas store with starter nodes/edges and enable auto-save history for the demo version ([Source: architecture/frontend-architecture.md#state-management-architecture], [Source: architecture/frontend-architecture.md#feature-modules])  
  - [ ] Show onboarding callouts and guided checklist modules on the dashboard redirect to teach the first backtest flow ([Source: architecture/frontend-architecture.md#feature-modules], [Source: architecture/core-workflows.md#core-workflows])
  - [ ] Seed the demo strategy `Quickstart Momentum` (StrategyVersion `v1`) with these blocks: **Data Source** (`BTC-USD`, 1d candles) → **Indicator** (EMA crossover, fast=12, slow=26) → **Signal Logic** (enter long on bullish crossover, exit on bearish crossover) → **Risk Control** (position size capped at 2% of equity, stop-loss 3%) → **Execution** (paper-trading adapter) so builders see all five canonical block types on load.
  - [ ] Invoke the PlanUsage quota service during demo workspace seeding so onboarding actions respect plan guardrails and surface quota errors gracefully ([Source: architecture/backend-architecture.md#quota-enforcement-service], [Source: architecture/data-models.md#planusage])
  - [ ] Attach the onboarding callouts `welcome-consent`, `canvas-tour`, `edit-parameters`, and `run-first-backtest` to the dashboard redirect so the checklist and tooltip system reinforce AC3.
- [ ] Instrument audit logging for auth events and workspace creation (AC: 4)  
  - [ ] Stream Supabase `auth.audit_log_events` into Datadog dashboards/alerts via the observability pipeline ([Source: architecture/security-and-performance.md#security-requirements], [Source: architecture/components.md#fastapi-core-service])  
  - [ ] Persist workspace creation metadata (user, strategy id, timestamp) using the compliance/audit tables for traceability ([Source: architecture/data-models.md#complianceevent], [Source: architecture/database-schema.md#database-schema])  
  - [ ] Emit audit notifications from FastAPI to the notification service so admins can review onboarding events ([Source: architecture/components.md#notification-service], [Source: architecture/core-workflows.md#core-workflows])
  - [ ] Add Datadog log-based monitor and dashboard tiles (auth success/fail counts, workspace creation events) to verify telemetry lands in the expected `service:auth` and `service:workspace` indexes ([Source: architecture/monitoring-and-observability.md#key-metrics])  
  - [ ] Capture compliance ingestion by writing `ComplianceEvent` rows and exporting a sample audit CSV to confirm storage schema matches governance requirements ([Source: architecture/data-models.md#complianceevent], [Source: architecture/deployment-architecture.md#initial-data-seeding--reference-fixtures])
- [ ] Verification and automated testing coverage (AC: 1-4)  
  - [ ] Add unit and integration tests for auth guards, workspace seeding service, and audit event pipeline per testing pyramid ([Source: architecture/testing-strategy.md#testing-pyramid], [Source: architecture/testing-strategy.md#backend])  
  - [ ] Write Playwright onboarding flow to cover login, consent, redirect, and educational callouts ([Source: architecture/testing-strategy.md#e2e])  
  - [ ] Add test coverage ensuring PlanUsage quota enforcement triggers and blocks demo provisioning when limits are exceeded ([Source: architecture/backend-architecture.md#quota-enforcement-service], [Source: architecture/data-models.md#planusage])  
  - [ ] Add API/service tests that simulate workspace provisioning and assert Datadog log export hooks receive `workspace.created` events and compliance tables persist matching metadata; include a Playwright assertion that the audit monitor badge updates post-login.  
  - [ ] Ensure CI runs `pnpm turbo run test` and `poetry run pytest apps/api` to keep pipelines green ([Source: architecture/development-workflow.md#development-commands])

## Dev Notes
### Previous Story Insights
- No previous stories exist; this is the inaugural epic deliverable, so there are no upstream learnings to incorporate.

### Data Models
- Supabase user records track ids, roles, plan tiers, and activity metadata that power auth guards and can store simulation-consent indicators alongside app metadata. [Source: architecture/data-models.md#user]
- Strategies represent the canonical workspace artifact and link to StrategyVersion snapshots used on the canvas; seeding both ensures every new user lands in an editable demo. [Source: architecture/data-models.md#strategy], [Source: architecture/data-models.md#strategyversion]
- PlanUsage entries back quota checks and must be respected even during onboarding to prevent overages. [Source: architecture/data-models.md#planusage]
- ComplianceEvent payloads provide a structured place to capture workspace creation metadata for audit review. [Source: architecture/data-models.md#complianceevent]

### Demo Strategy Composition
- `Quickstart Momentum` strategy seeded with StrategyVersion `v1` that contains the following node order so the demo reflects the canonical five-block flow: Data Source (`BTC-USD`, 1d candles) → Indicator (EMA crossover, fast=12, slow=26) → Signal Logic (long on bullish crossover, flat otherwise) → Risk Control (2% max capital allocation, 3% stop loss) → Execution (paper-trading adapter).
- Initial parameter tooltips must clarify users can adjust EMA lengths and risk thresholds before running their first backtest.
- Demo workspace auto-loads checklist callouts `welcome-consent`, `canvas-tour`, `edit-parameters`, and `run-first-backtest` to reinforce the guided flow required by AC3.

### API Specifications
- FastAPI exposes `/api/v1/strategies` and `/strategies/{strategyId}/versions` endpoints for creating default workspaces; use them instead of direct DB writes. [Source: architecture/api-specification.md#api-specification]
- Authenticated routes rely on the `get_current_user` dependency to validate Supabase JWTs and hydrate user metadata during each request. [Source: architecture/backend-architecture.md#middlewareguards]
- The quota enforcement service should be invoked when auto-seeding or running demo actions to honor plan guardrails. [Source: architecture/backend-architecture.md#quota-enforcement-service]

### Component Specifications
- Next.js route groups provide `(auth)/login` for the sign-in experience and `(dashboard)` for post-login redirects, ensuring protected navigation flows. [Source: architecture/frontend-architecture.md#routing-architecture]
- The canvas Zustand store (`bb-canvas`) persists graphs client-side, letting the demo strategy load immediately with validation hooks. [Source: architecture/frontend-architecture.md#state-management-architecture]
- Onboarding and education hub modules deliver guided checklists and tooltips that surface on the first-visit dashboard. [Source: architecture/frontend-architecture.md#feature-modules]
- The shared frontend service layer injects Supabase tokens into API calls, so additional consent checks must live alongside the client wrapper. [Source: architecture/frontend-architecture.md#frontend-services-layer]
- Audit notifications should leverage the notification service to alert admins when new workspaces are provisioned. [Source: architecture/components.md#notification-service]

### File Locations
- Monorepo layout places Next.js at `apps/web`, FastAPI at `apps/api`, workers at `apps/workers`, and shared contracts in `packages/shared`. [Source: architecture/unified-project-structure.md#unified-project-structure]
- Backend routers reside under `apps/api/src/api/routers`, so new auth and strategy endpoints should extend those modules. [Source: architecture/backend-architecture.md#controllerroute-organization]
- CI configuration lives in `.github/workflows/`, aligning with the Turborepo-based lint/test pipeline. [Source: architecture/unified-project-structure.md#unified-project-structure]

### Testing Requirements
- Follow the testing pyramid to balance backend unit/integration coverage with E2E onboarding checks before release. [Source: architecture/testing-strategy.md#testing-pyramid]
- Respect plan guardrails in automated tests to avoid masking quota enforcement regressions. [Source: architecture/backend-architecture.md#quota-enforcement-service]
- Integration suites must mock Datadog intake and assert `auth.audit_log_events` and `workspace.created` records produce the expected telemetry payloads, while database snapshots confirm `ComplianceEvent` rows persist metadata for audit exports. [Source: architecture/testing-strategy.md#backend]

### Technical Constraints
- Shared contracts must originate in `packages/shared` to avoid drift, and all FastAPI/Next.js code paths need to remain async. [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Supabase JWT security, audit log streaming, and MFA/password policies are mandatory for the auth stack; do not bypass them when adding consent gates. [Source: architecture/security-and-performance.md#security-requirements]
- Platform architecture couples Next.js on Vercel with FastAPI on AWS Fargate and Celery workers, so new components must align with this deployment topology. [Source: architecture/high-level-architecture.md#technical-summary]
- CI/CD relies on GitHub Actions, Terraform, and Vercel hooks; ensure new pipelines plug into this stack. [Source: architecture/tech-stack.md#tech-stack]
- Architecture docs do not specify a dedicated schema field for simulation consent; coordinate with compliance before finalizing storage beyond Supabase app metadata.

### Project Structure Notes
- Planned services align with the documented Turborepo structure; no structural conflicts are anticipated when adding authentication, demo seeding, or audit instrumentation. [Source: architecture/unified-project-structure.md#unified-project-structure]

### Environment & Tooling
- Developers should bootstrap via `pnpm install`, Poetry environments for `apps/api` and `apps/workers`, and parallel dev servers orchestrated by Turborepo. [Source: architecture/development-workflow.md#initial-setup]
- Local `.env` files must include Supabase, database, Redis, Stripe, and OTEL variables for the auth flow and audit pipelines to function. [Source: architecture/development-workflow.md#environment-configuration]

### Testing
- Frontend unit and integration tests live under `apps/web/tests` using React Testing Library and custom test utils. [Source: architecture/testing-strategy.md#frontend]
- Backend tests run with pytest beneath `apps/api/tests`, covering both unit services and async integration flows. [Source: architecture/testing-strategy.md#backend]
- E2E tests utilize Playwright under `tests/e2e/`, and the onboarding/login scenario should expand `onboarding.spec.ts`. [Source: architecture/testing-strategy.md#e2e]
- CI execution should invoke `pnpm turbo run test` for frontend suites and `poetry run pytest apps/api` for backend coverage. [Source: architecture/development-workflow.md#development-commands]

## Change Log
| Date       | Version | Description    | Author            |
| ---------- | ------- | -------------- | ----------------- |
| 2025-10-10 | v1      | Initial draft. | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
- 2025-10-11 (Quinn – QA): Generated risk profile at `docs/qa/assessments/1.1-risk-20251011.md`. Critical: SEC-001 (consent enforcement bypass). High: SEC-002, TECH-001, DATA-001, OPS-001. Medium: PERF-001. Mitigations and test focus areas documented.
- 2025-10-11 (Quinn – QA): Authored test design matrix at `docs/qa/assessments/1.1-test-design-20251011.md` covering 16 scenarios (10×P0, 6×P1) across unit/integration/E2E layers with gate summary snippet prepared.
