# Story 1.1: Platform Skeleton & Authentication

## Status
Draft

## Story
**As a** new user,  
**I want** to sign up, authenticate, and land in a pre-configured workspace,  
**so that** I can immediately begin exploring strategy building in a trustworthy environment.

## Acceptance Criteria
1. Monorepo initialized with Next.js frontend, FastAPI API gateway, shared schema package, and CI lint/test pipeline.
2. Supabase (or equivalent) authentication integrated with email/password and OAuth, enforcing simulation-only consent checkbox.
3. Post-login redirect initializes a demo strategy workspace populated with sample blocks and educational callouts.
4. Audit logging captures auth events and workspace creation metadata.

## Tasks / Subtasks
- [ ] Establish monorepo foundation and shared packages (AC: 1)  
  - [ ] Scaffold `apps/web`, `apps/api`, `apps/workers`, and `packages/shared` with Turborepo using Next.js 15, FastAPI, and shared schema stubs to match the canonical layout ([Source: architecture/unified-project-structure.md#unified-project-structure], [Source: architecture/tech-stack.md#tech-stack])  
  - [ ] Wire shared TypeScript/Pydantic contracts from `packages/shared` into the Next.js API client and FastAPI router skeletons to keep a single source of truth ([Source: architecture/coding-standards.md#critical-fullstack-rules])  
  - [ ] Configure GitHub Actions + Turborepo pipeline to lint and test web/api apps on every push ([Source: architecture/tech-stack.md#tech-stack], [Source: architecture/development-workflow.md#development-commands])  
  - [ ] Provide `.env` and `.env.local` templates with API, Supabase, Stripe, Redis, OTEL, and logging variables so developers can bootstrap locally ([Source: architecture/development-workflow.md#environment-configuration])
- [ ] Implement Supabase authentication and consent enforcement (AC: 2)  
  - [ ] Integrate Supabase Auth in Next.js via `createClientComponentClient`, login route group under `(auth)/login`, and service-layer token injection ([Source: architecture/frontend-architecture.md#frontend-services-layer], [Source: architecture/frontend-architecture.md#routing-architecture])  
  - [ ] Surface a `simulation-consent` checkbox in `(auth)/login/page.tsx`, disable Sign Up/Sign In actions until checked, and persist acknowledgement through the Supabase metadata update so UI and API both enforce consent ([Source: architecture/frontend-architecture.md#component-architecture], [Source: architecture/coding-standards.md#critical-fullstack-rules])  
  - [ ] Define Supabase `app_metadata.consents.simulationOnly` (boolean + timestamp) contract in `packages/shared`, migrations, and docs so consent persistence has an explicit schema reviewed with compliance ([Source: architecture/backend-architecture.md#auth-flow], [Source: architecture/coding-standards.md#critical-fullstack-rules])  
  - [ ] Secure FastAPI routes with the `get_current_user` dependency, syncing Supabase user/app metadata on first login ([Source: architecture/backend-architecture.md#middlewareguards], [Source: architecture/backend-architecture.md#auth-flow])  
  - [ ] Persist simulation-only consent acknowledgement in Supabase app metadata and enforce API/route access until present ([Source: architecture/backend-architecture.md#auth-flow])  
  - [ ] Enable email/password and OAuth providers, ensuring token refresh and session hardening follow security guardrails ([Source: architecture/security-and-performance.md#security-requirements])
- [ ] Provision demo workspace after authentication (AC: 3)  
  - [ ] On successful auth, call FastAPI to create or fetch a seeded `Strategy` plus first `StrategyVersion` for the user using `/api/v1/strategies` and `/strategies/{strategyId}/versions` ([Source: architecture/api-specification.md#api-specification], [Source: architecture/data-models.md#strategy])  
  - [ ] Populate the Zustand canvas store with starter nodes/edges and enable auto-save history for the demo version ([Source: architecture/frontend-architecture.md#state-management-architecture], [Source: architecture/frontend-architecture.md#feature-modules])  
  - [ ] Show onboarding callouts and guided checklist modules on the dashboard redirect to teach the first backtest flow ([Source: architecture/frontend-architecture.md#feature-modules], [Source: architecture/core-workflows.md#core-workflows])
  - [ ] Seed the demo strategy `Quickstart Momentum` (StrategyVersion `v1`) with these blocks: **Data Source** (`BTC-USD`, 1d candles) → **Indicator** (EMA crossover, fast=12, slow=26) → **Signal Logic** (enter long on bullish crossover, exit on bearish crossover) → **Risk Control** (position size capped at 2% of equity, stop-loss 3%) → **Execution** (paper-trading adapter) so builders see all five canonical block types on load. ([Source: docs/front-end-spec.md#quickstart-momentum-demo])
  - [ ] Invoke the PlanUsage quota service during demo workspace seeding so onboarding actions respect plan guardrails and surface quota errors gracefully ([Source: architecture/backend-architecture.md#quota-enforcement-service], [Source: architecture/data-models.md#planusage])
  - [ ] Inside the FastAPI onboarding/demos seeding workflow (expected in `apps/api/src/services/workspace_seed_service.py`), call `PlanUsageService.assert_within_quota(user.id, 'backtests')` before creating strategies so quota exhaustion raises `QuotaExceededError` (HTTP 403) with upgrade messaging returned to the frontend.  
  - [ ] Attach the onboarding callouts `welcome-consent`, `canvas-tour`, `edit-parameters`, and `run-first-backtest` to the dashboard redirect so the checklist and tooltip system reinforce AC3. ([Source: front-end-spec.md#onboarding-checklist])
  - [ ] Publish the onboarding checklist/callout registry in `packages/shared/onboarding/callouts.ts` with the IDs above and copy documented in the *Onboarding Checklist & Callout Specification* section so web/app parity is maintained.
- [ ] Instrument audit logging for auth events and workspace creation (AC: 4)  
  - [ ] Stream Supabase `auth.audit_log_events` into Datadog dashboards/alerts via the observability pipeline ([Source: architecture/security-and-performance.md#security-requirements], [Source: architecture/components.md#fastapi-core-service])  
  - [ ] Persist workspace creation metadata (user, strategy id, timestamp) using the compliance/audit tables for traceability ([Source: architecture/data-models.md#complianceevent], [Source: architecture/database-schema.md#database-schema])  
  - [ ] Emit audit notifications from FastAPI to the notification service so admins can review onboarding events ([Source: architecture/components.md#notification-service], [Source: architecture/core-workflows.md#core-workflows])
  - [ ] Add Datadog log-based monitor and dashboard tiles (auth success/fail counts, workspace creation events) to verify telemetry lands in the expected `service:auth-gateway` and `service:workspace-seeding` indexes ([Source: architecture/monitoring-and-observability.md#log-index-tags])  
  - [ ] Provide a local observability shim (`scripts/mock_datadog_agent.py`) that starts an HTTP server echoing Datadog log payloads to stdout so developers can validate emissions without a real Datadog account; document usage in the repo README.  
  - [ ] Capture compliance ingestion by writing `ComplianceEvent` rows and exporting a sample audit CSV to confirm storage schema matches governance requirements ([Source: architecture/data-models.md#complianceevent], [Source: architecture/deployment-architecture.md#initial-data-seeding--reference-fixtures])
- [ ] Verification and automated testing coverage (AC: 1-4)  
  - [ ] Add unit and integration tests for auth guards, workspace seeding, and audit pipelines, following the testing pyramid guidance ([Source: architecture/testing-strategy.md#testing-pyramid], [Source: architecture/testing-strategy.md#backend])  
  - [ ] Write Playwright onboarding flow covering login, consent, redirect, and educational callouts ([Source: architecture/testing-strategy.md#e2e])  
  - [ ] Add PlanUsage quota enforcement tests so seeding workflows and CTA guards block when limits are exceeded ([Source: architecture/backend-architecture.md#quota-enforcement-service], [Source: architecture/data-models.md#planusage])  
  - [ ] Add API/service tests that simulate workspace provisioning and assert Datadog log export hooks receive `workspace.created` events and compliance tables persist matching metadata; include a Playwright assertion that the audit monitor badge updates post-login.  
  - [ ] FastAPI service tests must mock `PlanUsageRepository.get_active_window` to cover both allowed and throttled paths for `PlanUsageService.assert_within_quota`, verifying the seeding workflow increments usage on success and returns HTTP 403 with `quota_exceeded` payload on exhaustion.  
  - [ ] Use the local Datadog shim by setting `DATADOG_LOG_ENDPOINT=http://127.0.0.1:8282/logs` during integration tests (patch `settings.datadog_log_endpoint`) and assert payloads with `tests/utils/datadog_sink.py` so telemetry expectations are verifiable offline.  
  - [ ] Test suite locations: frontend `apps/web/tests`, backend `apps/api/tests`, and Playwright under `tests/e2e/`. Run `pnpm turbo run test` (frontend) and `poetry run pytest apps/api` (backend) locally and in CI ([Source: architecture/testing-strategy.md#frontend], [Source: architecture/testing-strategy.md#backend], [Source: architecture/development-workflow.md#development-commands])

## Dev Notes
### Previous Story Insights
- No previous stories exist; this is the inaugural epic deliverable, so there are no upstream learnings to incorporate.

### Data Models
- Supabase user records track ids, roles, plan tiers, and activity metadata that power auth guards and can store simulation-consent indicators alongside app metadata. [Source: architecture/data-models.md#user]
- Strategies represent the canonical workspace artifact and link to StrategyVersion snapshots used on the canvas; seeding both ensures every new user lands in an editable demo. [Source: architecture/data-models.md#strategy], [Source: architecture/data-models.md#strategyversion]
- PlanUsage entries back quota checks and must be respected even during onboarding to prevent overages. [Source: architecture/data-models.md#planusage]
- ComplianceEvent payloads provide a structured place to capture workspace creation metadata for audit review. [Source: architecture/data-models.md#complianceevent]

### Demo Strategy Composition
- `Quickstart Momentum` strategy seeded with StrategyVersion `v1` that contains the following node order so the demo reflects the canonical five-block flow: Data Source (`BTC-USD`, 1d candles) → Indicator (EMA crossover, fast=12, slow=26) → Signal Logic (long on bullish crossover, flat otherwise) → Risk Control (2% max capital allocation, 3% stop loss) → Execution (paper-trading adapter). ([Source: docs/front-end-spec.md#quickstart-momentum-demo])
- Initial parameter tooltips must clarify users can adjust EMA lengths and risk thresholds before running their first backtest.
- Demo workspace auto-loads checklist callouts `welcome-consent`, `canvas-tour`, `edit-parameters`, and `run-first-backtest` to reinforce the guided flow required by AC3. ([Source: front-end-spec.md#onboarding-checklist])
- Dashboard redirect must hydrate `['planUsage','backtests']` via React Query and run the `assertBacktestQuota` guard (see `architecture/frontend-architecture.md#frontend-services-layer`) so the `run-first-backtest` CTA disables itself and surfaces the upgrade modal whenever `used >= limit`.

### Onboarding Checklist & Callout Specification
> Reference: `docs/front-end-spec.md#onboarding-checklist`
| ID | Trigger Location | Title / Headline | Body Copy | Primary CTA | Secondary Action | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| `welcome-consent` | Dashboard redirect immediately after first login | "Welcome to Blockbuilders" | "Before we spin up your sandbox, confirm you understand everything here runs in simulation only. You can explore safely—no live capital is touched yet." | "Acknowledge & Continue" | "View Simulation Policy" (links to `/legal/simulation-policy`) | Checkbox state persists to Supabase `app_metadata.consents.simulationOnly`. |
| `canvas-tour` | First open of strategy canvas | "Take a quick canvas tour" | "Learn how each block—from data to execution—connects in your strategy. We highlight the essentials so you can navigate with confidence." | "Start Tour" | "Skip for now" | Tour walks nodes in seeded order with inline highlights. |
| `edit-parameters` | After tour completes or when user selects Indicator block | "Try editing your parameters" | "Tweak the EMA lengths to see how your strategy responds. We’ll validate settings automatically so you stay within best-practice guardrails." | "Edit EMA Settings" | "Learn More" (opens docs modal) | CTA focuses indicator sidebar; validation messaging references coding standards. |
| `run-first-backtest` | After parameters edited or user lands on backtest panel | "Run your first backtest" | "Kick off a simulated run to review performance, risk, and next steps. You’re just one click from your first results." | "Run Backtest" | "Review Checklist" | Callout verifies quota via PlanUsage before enabling CTA. |

**Configuration Guidance**
- Store the table above verbatim in `packages/shared/onboarding/callouts.ts` (ID, title, body, CTA labels, links) so both frontend tooltips and backend audits consume the same contract.
- Mirror the copy in `docs/front-end-spec.md#onboarding-checklist` to keep UX documentation in sync; update that section whenever labels change.
- Checklist completion order is linear (`welcome-consent` → `canvas-tour` → `edit-parameters` → `run-first-backtest`), but allow replays from the onboarding drawer using the same IDs.
- When the `run-first-backtest` callout renders, retrieve `PlanUsage` for the current user from `/api/v1/plan-usage/backtests`, pass it through `assertBacktestQuota`, and block CTA clicks until the guard confirms `used < limit`; if throttled, display the upgrade dialog referenced in the PRD.

### API Specifications
- FastAPI exposes `/api/v1/strategies` and `/strategies/{strategyId}/versions` endpoints for creating default workspaces; use them instead of direct DB writes. [Source: architecture/api-specification.md#api-specification]
- Authenticated routes rely on the `get_current_user` dependency to validate Supabase JWTs and hydrate user metadata during each request. [Source: architecture/backend-architecture.md#middlewareguards]
- The quota enforcement service should be invoked when auto-seeding or running demo actions to honor plan guardrails. [Source: architecture/backend-architecture.md#quota-enforcement-service]
- Provide `GET /api/v1/plan-usage/{metric}` (returning the `PlanUsage` DTO from `packages/shared`) for frontend guards and ensure onboarding flows request `metric=backtests`; expose `POST /api/v1/plan-usage/assert` or reuse the seeding endpoint to surface `quota_exceeded` errors raised by `PlanUsageService.assert_within_quota`.

### Component Specifications
- Next.js route groups provide `(auth)/login` for the sign-in experience and `(dashboard)` for post-login redirects, ensuring protected navigation flows. [Source: architecture/frontend-architecture.md#routing-architecture]
- The canvas Zustand store (`bb-canvas`) persists graphs client-side, letting the demo strategy load immediately with validation hooks. [Source: architecture/frontend-architecture.md#state-management-architecture]
- Onboarding and education hub modules deliver guided checklists and tooltips that surface on the first-visit dashboard. [Source: architecture/frontend-architecture.md#feature-modules]
- The shared frontend service layer injects Supabase tokens into API calls, so additional consent checks must live alongside the client wrapper. [Source: architecture/frontend-architecture.md#frontend-services-layer]
- Audit notifications should leverage the notification service to alert admins when new workspaces are provisioned. [Source: architecture/components.md#notification-service]
- UI layouts must follow Tailwind utility conventions and design tokens defined for the project so styles stay consistent. [Source: architecture/tech-stack.md#tech-stack]
- Strategy canvas interactions are built on React Flow primitives; extend the existing node/edge definitions rather than reinventing visuals. [Source: architecture/tech-stack.md#tech-stack]
- Icons in login and onboarding surfaces should use the Lucid icon set to stay on-brand. [Source: architecture/tech-stack.md#tech-stack]

### File Locations
- Monorepo layout places Next.js at `apps/web`, FastAPI at `apps/api`, workers at `apps/workers`, and shared contracts in `packages/shared`. [Source: architecture/unified-project-structure.md#unified-project-structure]
- Backend routers reside under `apps/api/src/api/routers`, so new auth and strategy endpoints should extend those modules. [Source: architecture/backend-architecture.md#controllerroute-organization]
- CI configuration lives in `.github/workflows/`, aligning with the Turborepo-based lint/test pipeline. [Source: architecture/unified-project-structure.md#unified-project-structure]

### Technical Constraints
- Shared contracts must originate in `packages/shared` to avoid drift, and all FastAPI/Next.js code paths need to remain async. [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Supabase JWT security, audit log streaming, and MFA/password policies are mandatory for the auth stack; do not bypass them when adding consent gates. [Source: architecture/security-and-performance.md#security-requirements]
- Platform architecture couples Next.js on Vercel with FastAPI on AWS Fargate and Celery workers, so new components must align with this deployment topology. [Source: architecture/high-level-architecture.md#technical-summary]
- CI/CD relies on GitHub Actions, Terraform, and Vercel hooks; ensure new pipelines plug into this stack. [Source: architecture/tech-stack.md#tech-stack]
- Establish Supabase `app_metadata.consents.simulationOnly` schema and capture compliance sign-off before implementation so consent storage is explicit and auditable.
- Observability exports must honor `settings.datadog_log_endpoint`, defaulting to Datadog but overridable for local/shim targets so tests never reach external networks.

### Project Structure Notes
- Planned services align with the documented Turborepo structure; no structural conflicts are anticipated when adding authentication, demo seeding, or audit instrumentation. [Source: architecture/unified-project-structure.md#unified-project-structure]

### Environment & Tooling
- Developers should bootstrap via `pnpm install`, Poetry environments for `apps/api` and `apps/workers`, and parallel dev servers orchestrated by Turborepo. [Source: architecture/development-workflow.md#initial-setup]
- Local `.env` files must include Supabase, database, Redis, Stripe, and OTEL variables for the auth flow and audit pipelines to function. [Source: architecture/development-workflow.md#environment-configuration]
- When developing telemetry, run `python scripts/mock_datadog_agent.py --port 8282` and point `DATADOG_LOG_ENDPOINT`/`DD_SITE` overrides to `http://127.0.0.1:8282` so log exports can be verified without external network calls.

## Change Log
| Date       | Version | Description    | Author            |
| ---------- | ------- | -------------- | ----------------- |
| 2025-10-10 | v1      | Initial draft. | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
- 2025-10-11 (Quinn – QA): Generated risk profile at `docs/qa/assessments/1.1-risk-20251011.md`. Critical: SEC-001 (consent enforcement bypass). High: SEC-002, TECH-001, DATA-001, OPS-001. Medium: PERF-001. Mitigations and test focus areas documented.
- 2025-10-11 (Quinn – QA): Authored test design matrix at `docs/qa/assessments/1.1-test-design-20251011.md` covering 16 scenarios (10×P0, 6×P1) across unit/integration/E2E layers with gate summary snippet prepared.
